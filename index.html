<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Captador - MindSoccer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="text-white">

    <div id="login-container" class="min-h-screen flex items-center justify-center fade-in">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md">
            <h1 class="text-2xl font-bold text-center text-orange-400 mb-6">Portal do Captador</h1>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-300">Seu Nome Completo</label>
                    <input type="text" id="name" required class="w-full mt-1 w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-300">Email</label>
                    <input type="email" id="email" required class="w-full mt-1 w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-300">Senha</label>
                    <input type="password" id="password" required class="w-full mt-1 w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500">
                </div>
                <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-md transition">Entrar / Registrar</button>
                <p id="login-error" class="text-red-400 text-sm text-center"></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-4xl hidden">
        <header class="flex justify-between items-start mb-8 pb-4 border-b border-gray-700">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-100">Portal do Captador</h1>
                <p id="user-display" class="text-sm text-blue-400"></p>
            </div>
            <div id="level-display" class="flex flex-col items-center"></div>
            <div class="text-right flex items-center space-x-4">
                <button id="notification-bell" class="relative">
                    <svg class="w-6 h-6 text-gray-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    <span id="notification-badge" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden"></span>
                </button>
                <div>
                    <p class="font-semibold text-sm text-gray-300">MindSoccer</p>
                    <button id="logout-btn" class="mt-2 text-xs bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded">Sair</button>
                </div>
            </div>
        </header>

        <main>
            <section id="form-section" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
                <h2 class="text-xl font-semibold mb-4 text-orange-400">Registrar Novo Contato de Atleta</h2>
                <form id="captacao-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label for="atleta-nome" class="block text-sm font-medium text-gray-300 mb-1">Nome do Atleta</label>
                            <input type="text" id="atleta-nome" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label for="atleta-ano-nascimento" class="block text-sm font-medium text-gray-300 mb-1">Ano de Nascimento</label>
                            <input type="number" id="atleta-ano-nascimento" placeholder="Ex: 2007" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label for="atleta-estado" class="block text-sm font-medium text-gray-300 mb-1">Estado</label>
                            <select id="atleta-estado" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                                <option value="">Selecione o Estado</option>
                                <option value="AC">Acre</option>
                                <option value="AL">Alagoas</option>
                                <option value="AP">Amapá</option>
                                <option value="AM">Amazonas</option>
                                <option value="BA">Bahia</option>
                                <option value="CE">Ceará</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="ES">Espírito Santo</option>
                                <option value="GO">Goiás</option>
                                <option value="MA">Maranhão</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="PA">Pará</option>
                                <option value="PB">Paraíba</option>
                                <option value="PR">Paraná</option>
                                <option value="PE">Pernambuco</option>
                                <option value="PI">Piauí</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="RN">Rio Grande do Norte</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="RO">Rondônia</option>
                                <option value="RR">Roraima</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="SP">São Paulo</option>
                                <option value="SE">Sergipe</option>
                                <option value="TO">Tocantins</option>
                            </select>
                        </div>
                        <div>
                            <label for="atleta-telefone" class="block text-sm font-medium text-gray-300 mb-1">Telefone</label>
                            <input type="tel" id="atleta-telefone" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2" placeholder="(XX) XXXXX-XXXX">
                        </div>
                        <div>
                            <label for="atleta-posicao" class="block text-sm font-medium text-gray-300 mb-1">Posição</label>
                            <select id="atleta-posicao" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                                <option>Atacante</option>
                                <option>Meio-Campo</option>
                                <option>Volante</option>
                                <option>Zagueiro</option>
                                <option>Lateral</option>
                                <option>Goleiro</option>
                            </select>
                        </div>
                        <div>
                            <label for="responsavel-nome" class="block text-sm font-medium text-gray-300 mb-1">Nome do Responsável</label>
                            <input type="text" id="responsavel-nome" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label for="responsavel-telefone" class="block text-sm font-medium text-gray-300 mb-1">Telefone do Responsável</label>
                            <input type="tel" id="responsavel-telefone" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2" placeholder="(XX) XXXXX-XXXX">
                        </div>
                        </div>
                    <div class="space-y-4">
                        <div>
                            <label for="data-contato" class="block text-sm font-medium text-gray-300 mb-1">Data do Contato</label>
                            <input type="date" id="data-contato" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Status</label>
                            <div class="flex flex-wrap items-center gap-2 mt-2">
                                <input type="radio" id="status-aguardando" name="status" value="Aguardando" class="text-yellow-500"><label for="status-aguardando" class="ml-2 text-yellow-400">Aguardando</label>
                                <input type="radio" id="status-sucesso" name="status" value="Sucesso" class="text-green-500"><label for="status-sucesso" class="ml-2 text-green-400">Sucesso</label>
                                <input type="radio" id="status-falha" name="status" value="Falha" class="text-red-500"><label for="status-falha" class="ml-2 text-red-400">Falha</label>
                                <input type="radio" id="status-reuniao" name="status" value="Reunião Agendada" class="text-cyan-500"><label for="status-reuniao" class="ml-2 text-cyan-400">Reunião</label>
                                <input type="radio" id="status-standby" name="status" value="Standby" class="text-indigo-500"><label for="status-standby" class="ml-2 text-indigo-400">Standby</label>
                            </div>
                        </div>
                        <div id="campos-aguardando" class="fade-in">
                            <label for="previsao-resposta" class="block text-sm font-medium text-gray-300 mb-1">Acompanhamento / Previsão de Resposta</label>
                            <textarea id="previsao-resposta" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2" placeholder="Ex: Mãe pediu para retornar na sexta-feira."></textarea>
                        </div>
                        <div id="campos-reuniao" class="hidden space-y-4 fade-in">
                            <div>
                                <label for="data-reuniao" class="block text-sm font-medium text-gray-300 mb-1">Data da Reunião</label>
                                <input type="date" id="data-reuniao" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label for="hora-reuniao" class="block text-sm font-medium text-gray-300 mb-1">Hora da Reunião</label>
                                <input type="time" id="hora-reuniao" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                            </div>
                        </div>
                        <div id="campos-standby" class="hidden space-y-4 fade-in">
                            <div>
                                <label for="motivo-standby" class="block text-sm font-medium text-gray-300 mb-1">Motivo / Próximo Passo</label>
                                <textarea id="motivo-standby" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2" placeholder="Ex: Atleta machucou, aguardando melhora."></textarea>
                            </div>
                            <div>
                                <label for="data-lembrete" class="block text-sm font-medium text-gray-300 mb-1">Data do Lembrete</label>
                                <input type="date" id="data-lembrete" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                            </div>
                        </div>
                        <div id="campos-sucesso" class="hidden space-y-4 fade-in">
                            <div>
                                <label for="data-avaliacao" class="block text-sm font-medium text-gray-300 mb-1">Data da Avaliação</label>
                                <input type="date" id="data-avaliacao" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label for="nome-pagador" class="block text-sm font-medium text-gray-300 mb-1">Nome do Pagador</label>
                                <input type="text" id="nome-pagador" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label for="forma-pagamento" class="block text-sm font-medium text-gray-300 mb-1">Forma de Pagamento</label>
                                <select id="forma-pagamento" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                                    <option>Pix</option>
                                    <option>Dinheiro</option>
                                    <option>Cartão de Crédito</option>
                                </select>
                            </div>
                            <div>
                                <label for="valor-pago" class="block text-sm font-medium text-gray-300 mb-1">Valor Pago (R$)</label>
                                <input type="number" step="0.01" id="valor-pago" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label for="clube-destino" class="block text-sm font-medium text-gray-300 mb-1">Clube de Destino</label>
                                <input type="text" id="clube-destino" placeholder="Ex: Palmeiras" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                            </div>
                            </div>
                        <div id="campos-falha" class="hidden fade-in">
                            <label for="motivo-falha" class="block text-sm font-medium text-gray-300 mb-1">Motivo da Falha</label>
                            <textarea id="motivo-falha" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2" placeholder="Ex: Família sem condições..."></textarea>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" id="submit-button" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-md">Adicionar Registro</button>
                    </div>
                </form>
            </section>

            <section id="contatos-section" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold text-orange-400 mb-4">Meus Registros</h2>
                <div id="aviso-container" class="mb-4"></div>
                <div id="contatos-list" class="space-y-4 max-h-[32rem] overflow-y-auto pr-2"></div>
            </section>
        </main>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop fade-in">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 m-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-semibold text-orange-400 mb-4">Editar Registro</h2>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-doc-id">
                <div>
                    <label for="edit-atleta-nome" class="block text-sm">Nome</label>
                    <input type="text" id="edit-atleta-nome" required class="w-full mt-1 bg-gray-700 rounded-md p-2">
                </div>
                <div>
                    <label for="edit-atleta-ano-nascimento" class="block text-sm">Ano de Nascimento</label>
                    <input type="number" id="edit-atleta-ano-nascimento" required class="w-full mt-1 bg-gray-700 rounded-md p-2">
                </div>
                <div>
                    <label for="edit-atleta-estado" class="block text-sm">Estado</label>
                    <select id="edit-atleta-estado" required class="w-full bg-gray-700 rounded-md p-2">
                        <option value="">Selecione o Estado</option>
                        <option value="AC">Acre</option>
                        <option value="AL">Alagoas</option>
                        <option value="AP">Amapá</option>
                        <option value="AM">Amazonas</option>
                        <option value="BA">Bahia</option>
                        <option value="CE">Ceará</option>
                        <option value="DF">Distrito Federal</option>
                        <option value="ES">Espírito Santo</option>
                        <option value="GO">Goiás</option>
                        <option value="MA">Maranhão</option>
                        <option value="MT">Mato Grosso</option>
                        <option value="MS">Mato Grosso do Sul</option>
                        <option value="MG">Minas Gerais</option>
                        <option value="PA">Pará</option>
                        <option value="PB">Paraíba</option>
                        <option value="PR">Paraná</option>
                        <option value="PE">Pernambuco</option>
                        <option value="PI">Piauí</option>
                        <option value="RJ">Rio de Janeiro</option>
                        <option value="RN">Rio Grande do Norte</option>
                        <option value="RS">Rio Grande do Sul</option>
                        <option value="RO">Rondônia</option>
                        <option value="RR">Roraima</option>
                        <option value="SC">Santa Catarina</option>
                        <option value="SP">São Paulo</option>
                        <option value="SE">Sergipe</option>
                        <option value="TO">Tocantins</option>
                    </select>
                </div>
                <div>
                    <label for="edit-atleta-telefone" class="block text-sm">Número</label>
                    <input type="tel" id="edit-atleta-telefone" required class="w-full mt-1 bg-gray-700 rounded-md p-2">
                </div>

                <div>
                    <label for="edit-responsavel-nome" class="block text-sm">Nome do Responsável</label>
                    <input type="text" id="edit-responsavel-nome" class="w-full mt-1 bg-gray-700 rounded-md p-2">
                </div>
                <div>
                    <label for="edit-responsavel-telefone" class="block text-sm">Telefone do Responsável</label>
                    <input type="tel" id="edit-responsavel-telefone" class="w-full mt-1 bg-gray-700 rounded-md p-2">
                </div>
                <div id="gestor-mensagem-container" class="hidden">
                    <label class="block text-sm font-medium text-gray-400">Mensagem da Gestão</label>
                    <p id="view-gestor-mensagem" class="mt-1 text-gray-200 bg-gray-900 p-2 rounded-md italic"></p>
                </div>
                <div>
                    <label for="edit-status" class="block text-sm">Status</label>
                    <select id="edit-status" class="w-full mt-1 bg-gray-700 rounded-md p-2">
                        <option value="Aguardando">Aguardando</option>
                        <option value="Sucesso">Sucesso</option>
                        <option value="Falha">Falha</option>
                        <option value="Reunião Agendada">Reunião Agendada</option>
                        <option value="Standby">Standby</option>
                    </select>
                </div>
                <div id="edit-campos-aguardando" class="space-y-4">
                    <label for="edit-previsao-resposta" class="block text-sm">Acompanhamento</label>
                    <textarea id="edit-previsao-resposta" rows="2" class="w-full mt-1 bg-gray-700 rounded-md p-2"></textarea>
                </div>

                <div id="edit-campos-reuniao" class="hidden space-y-4">
                    <div>
                        <label for="edit-data-reuniao" class="block text-sm">Data da Reunião</label>
                        <input type="date" id="edit-data-reuniao" class="w-full mt-1 bg-gray-700 rounded-md p-2">
                    </div>
                    <div>
                        <label for="edit-hora-reuniao" class="block text-sm">Hora da Reunião</label>
                        <input type="time" id="edit-hora-reuniao" class="w-full mt-1 bg-gray-700 rounded-md p-2">
                    </div>
                </div>
                <div id="edit-campos-standby" class="hidden space-y-4">
                    <div>
                        <label for="edit-motivo-standby" class="block text-sm">Motivo / Próximo Passo</label>
                        <textarea id="edit-motivo-standby" rows="2" class="w-full mt-1 bg-gray-700 rounded-md p-2"></textarea>
                    </div>
                    <div>
                        <label for="edit-data-lembrete" class="block text-sm">Data do Lembrete</label>
                        <input type="date" id="edit-data-lembrete" class="w-full mt-1 bg-gray-700 rounded-md p-2">
                    </div>
                </div>
                <div id="edit-campos-sucesso" class="space-y-4">
                    <div>
                        <label for="edit-data-avaliacao" class="block text-sm">Data Avaliação</label>
                        <input type="date" id="edit-data-avaliacao" class="w-full mt-1 bg-gray-700 rounded-md p-2">
                    </div>
                    <div>
                        <label for="edit-nome-pagador" class="block text-sm">Nome do Pagador</label>
                        <input type="text" id="edit-nome-pagador" class="w-full mt-1 bg-gray-700 rounded-md p-2">
                    </div>
                    <div>
                        <label for="edit-forma-pagamento" class="block text-sm">Forma de Pagamento</label>
                        <select id="edit-forma-pagamento" class="w-full mt-1 bg-gray-700 rounded-md p-2">
                            <option>Pix</option>
                            <option>Dinheiro</option>
                            <option>Cartão de Crédito</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-valor-pago" class="block text-sm">Valor Pago (R$)</label>
                        <input type="number" step="0.01" id="edit-valor-pago" class="w-full mt-1 bg-gray-700 rounded-md p-2">
                    </div>
                    <div>
                        <label for="edit-clube-destino" class="block text-sm">Clube de Destino</label>
                        <input type="text" id="edit-clube-destino" placeholder="Ex: Flamengo, Palmeiras..." class="w-full mt-1 bg-gray-700 rounded-md p-2">
                    </div>
                    </div>
                <div id="edit-campos-falha">
                    <label for="edit-motivo-falha" class="block text-sm">Motivo</label>
                    <textarea id="edit-motivo-falha" rows="2" class="w-full mt-1 bg-gray-700 rounded-md p-2"></textarea>
                </div>
                
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-md">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-md">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop fade-in">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 m-4 max-h-[70vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-orange-400">Notificações</h2>
                <button id="notification-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="notification-list" class="flex-grow overflow-y-auto space-y-3">
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, deleteDoc, updateDoc, serverTimestamp, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyANHJr8an_CQDUQQph8PfFx62ZsZhDRSF4",
            authDomain: "mindsoccer-app.firebaseapp.com",
            projectId: "mindsoccer-app",
            storageBucket: "mindsoccer-app.appspot.com",
            messagingSenderId: "855191571293",
            appId: "1:855191571293:web:d84fa499cc184ef73f76b4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const captacaoForm = document.getElementById('captacao-form');
        const contatosList = document.getElementById('contatos-list');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const avisoContainer = document.getElementById('aviso-container');
        const levelDisplay = document.getElementById('level-display');
        const notificationBell = document.getElementById('notification-bell');
        const notificationBadge = document.getElementById('notification-badge');
        const notificationModal = document.getElementById('notification-modal');
        const notificationList = document.getElementById('notification-list');
        const notificationCloseBtn = document.getElementById('notification-close-btn');
        const viewGestorMensagem = document.getElementById('view-gestor-mensagem');
        const gestorMensagemContainer = document.getElementById('gestor-mensagem-container');
        const [responsavelNomeInput, responsavelTelefoneInput] = ['responsavel-nome', 'responsavel-telefone'].map(id => document.getElementById(id));
        const [editResponsavelNomeInput, editResponsavelTelefoneInput] = ['edit-responsavel-nome', 'edit-responsavel-telefone'].map(id => document.getElementById(id));
        const [camposAguardando, camposSucesso, camposFalha, camposReuniao, camposStandby] = ['campos-aguardando', 'campos-sucesso', 'campos-falha', 'campos-reuniao', 'campos-standby'].map(id => document.getElementById(id));
        const [editCamposAguardando, editCamposSucesso, editCamposFalha, editCamposReuniao, editCamposStandby] = ['edit-campos-aguardando', 'edit-campos-sucesso', 'edit-campos-falha', 'edit-campos-reuniao', 'edit-campos-standby'].map(id => document.getElementById(id));

        let currentUser = null;
        let meusContatos = [];
        let minhasNotificacoes = [];
        let contatoOriginal = null;

        // --- FUNÇÕES DE NÍVEL (Sem alterações) ---
        function determinarNivel(contagem) {
            const trophyIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 11l3-3m0 0l3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6.75a2.25 2.25 0 012.25-2.25h1.5A2.25 2.25 0 0115 6.75V19M6 19h12" /></svg>`;
            if (contagem < 10) {
                return { nome: 'Blue', cor: 'text-blue-400', icone: trophyIcon.replace('h-6 w-6', 'h-6 w-6 text-blue-400'), progresso: `${contagem} / 10 para Gold` };
            } else if (contagem < 35) {
                return { nome: 'Gold', cor: 'text-yellow-400', icone: trophyIcon.replace('h-6 w-6', 'h-6 w-6 text-yellow-400'), progresso: `${contagem - 10} / 25 para Black` };
            } else {
                return { nome: 'Black', cor: 'text-gray-200', icone: trophyIcon.replace('h-6 w-6', 'h-6 w-6 text-gray-200'), progresso: 'Nível Máximo' };
            }
        }

        function atualizarDisplayNivel(contagem) {
            const nivel = determinarNivel(contagem);
            levelDisplay.innerHTML = `<div class="flex items-center gap-2">${nivel.icone}<span class="font-bold text-lg ${nivel.cor}">${nivel.nome}</span></div><div class="text-xs text-gray-400 mt-1">${nivel.progresso}</div>`;
        }

        // --- FUNÇÕES DE NOTIFICAÇÃO (MODIFICADA) ---
        function escutarNotificacoes() {
            if (!currentUser) return;
            const q = query(collection(db, "notificacoes"), where("destinatarioId", "==", currentUser.uid), orderBy("timestamp", "desc"));

            onSnapshot(q, (snapshot) => {
                minhasNotificacoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const naoLidas = minhasNotificacoes.filter(n => !n.lida).length;
                if (naoLidas > 0) {
                    notificationBadge.textContent = naoLidas;
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                }
                renderizarListaDeNotificacoes();
            }, (error) => {
                console.error("Erro ao buscar notificações: ", error);
                alert("Não foi possível carregar as notificações. Verifique o console para mais detalhes.");
            });
        }

        function renderizarListaDeNotificacoes() {
            notificationList.innerHTML = '';
            if (minhasNotificacoes.length === 0) {
                notificationList.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma notificação ainda.</p>';
                return;
            }

            minhasNotificacoes.forEach(n => {
                const item = document.createElement('div');
                const icon = n.tipo === 'confirmacao' ? '<span class="text-2xl">✅</span>' : '<span class="text-2xl">📢</span>';
                item.className = `p-4 rounded-lg flex items-start gap-4 transition ${n.lida ? 'bg-gray-700/50' : 'bg-blue-900/40 border border-blue-700'}`;
                item.innerHTML = `
                    <div>${icon}</div>
                    <div class="flex-1">
                        <p class="text-gray-200 text-sm">${n.mensagem}</p>
                        <p class="text-xs text-gray-400 mt-2">${n.timestamp ? formatarDataRelativa(n.timestamp.toDate()) : ''}</p>
                    </div>
                `;
                notificationList.appendChild(item);
            });
        }

        async function marcarNotificacoesComoLidas() {
            const naoLidasIds = minhasNotificacoes.filter(n => !n.lida).map(n => n.id);
            if (naoLidasIds.length === 0) return;
            const promessasDeUpdate = naoLidasIds.map(id => {
                const docRef = doc(db, "notificacoes", id);
                return updateDoc(docRef, { lida: true });
            });
            try {
                await Promise.all(promessasDeUpdate);
            } catch (error) {
                console.error("Erro ao marcar notificações como lidas: ", error);
            }
        }

        function formatarDataRelativa(data) {
            const agora = new Date();
            const diffSegundos = Math.round((agora - data) / 1000);
            const diffMinutos = Math.round(diffSegundos / 60);
            const diffHoras = Math.round(diffMinutos / 60);
            const diffDias = Math.round(diffHoras / 24);

            if (diffSegundos < 60) return `agora mesmo`;
            if (diffMinutos < 60) return `há ${diffMinutos} min`;
            if (diffHoras < 24) return `há ${diffHoras}h`;
            if (diffDias === 1) return `ontem`;
            return `há ${diffDias} dias`;
        }

        notificationBell.addEventListener('click', () => {
            notificationModal.style.display = 'flex';
            marcarNotificacoesComoLidas();
        });

        notificationCloseBtn.addEventListener('click', () => {
            notificationModal.style.display = 'none';
        });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                userDisplay.textContent = `Captador: ${user.displayName || user.email}`;
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                carregarContatos();
                escutarNotificacoes();
            } else {
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        function formatarTelefone(numero) {
            if (!numero || typeof numero !== 'string') return 'N/A';
            const numeroLimpo = numero.replace(/\D/g, '');
            if (numeroLimpo.length === 11) {
                return `(${numeroLimpo.substring(0, 2)}) ${numeroLimpo.substring(2, 7)}-${numeroLimpo.substring(7)}`;
            }
            if (numeroLimpo.length === 10) {
                return `(${numeroLimpo.substring(0, 2)}) ${numeroLimpo.substring(2, 6)}-${numeroLimpo.substring(6)}`;
            }
            return numero;
        }

        const aplicarMascaraTelefone = (event) => {
            let input = event.target;
            let value = input.value.replace(/\D/g, '');
            value = value.substring(0, 11);
            if (value.length > 2 && value.length <= 6) {
                value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
            } else if (value.length > 6) {
                value = `(${value.substring(0, 2)}) ${value.substring(2, 7)}-${value.substring(7)}`;
            } else if (value.length > 0) {
                value = `(${value}`;
            }
            input.value = value;
        };

        document.getElementById('atleta-telefone').addEventListener('input', aplicarMascaraTelefone);
        document.getElementById('edit-atleta-telefone').addEventListener('input', aplicarMascaraTelefone);
        document.getElementById('responsavel-telefone').addEventListener('input', aplicarMascaraTelefone);
        document.getElementById('edit-responsavel-telefone').addEventListener('input', aplicarMascaraTelefone);

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            document.getElementById('login-error').textContent = '';

            signInWithEmailAndPassword(auth, email, password).catch((error) => {
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    if (!name) {
                        document.getElementById('login-error').textContent = 'Preencha seu nome para o primeiro acesso.';
                        return;
                    }
                    createUserWithEmailAndPassword(auth, email, password)
                        .then(userCredential => updateProfile(userCredential.user, { displayName: name }))
                        .catch(err => document.getElementById('login-error').textContent = `Erro: ${err.message}`);
                } else {
                    document.getElementById('login-error').textContent = `Erro. Verifique e-mail e senha.`;
                }
            });
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        captacaoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';

            const status = captacaoForm.querySelector('input[name="status"]:checked').value;

            try {
                const novoContato = {
                    captadorId: currentUser.uid,
                    captadorEmail: currentUser.email,
                    captadorNome: currentUser.displayName,
                    criadoEm: serverTimestamp(),
                    nome: document.getElementById('atleta-nome').value,
                    anoNascimento: parseInt(document.getElementById('atleta-ano-nascimento').value),
                    estado: document.getElementById('atleta-estado').value,
                    telefone: document.getElementById('atleta-telefone').value.replace(/\D/g, ''),
                    nomeResponsavel: responsavelNomeInput.value,
                    telefoneResponsavel: responsavelTelefoneInput.value.replace(/\D/g, ''),
                    posicao: document.getElementById('atleta-posicao').value,
                    data: document.getElementById('data-contato').value,
                    status: status,
                    confirmado: status === 'Sucesso' ? false : null,
                    previsaoResposta: status === 'Aguardando' ? document.getElementById('previsao-resposta').value : null,
                    dataAvaliacao: status === 'Sucesso' ? document.getElementById('data-avaliacao').value : null,
                    valorPago: status === 'Sucesso' ? parseFloat(document.getElementById('valor-pago').value) || 0 : null,
                    formaPagamento: status === 'Sucesso' ? document.getElementById('forma-pagamento').value : null,
                    nomePagador: status === 'Sucesso' ? document.getElementById('nome-pagador').value : null,
                    motivo: status === 'Falha' ? document.getElementById('motivo-falha').value : '',
                    
                    historicoStatus: [
                        { status: status, dataHora: new Date(), alteradoPor: currentUser.displayName }
                    ]
                };

                await addDoc(collection(db, "captacoes"), novoContato);
                captacaoForm.reset();
                document.getElementById('data-contato').valueAsDate = new Date();
                toggleStatusFields();
                carregarContatos();

            } catch (error) {
                console.error("Erro ao salvar registro:", error);
                alert("Ocorreu um erro ao salvar. Tente novamente.");
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Adicionar Registro';
            }
        });

        async function carregarContatos() {
            if (!currentUser) return;
            contatosList.innerHTML = '<p class="text-gray-400">Carregando...</p>';

            const q = query(collection(db, "captacoes"), where("captadorId", "==", currentUser.uid), orderBy("criadoEm", "desc"));

            try {
                const querySnapshot = await getDocs(q);
                meusContatos = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const captsConfirmadas = meusContatos.filter(c => c.status === 'Sucesso' && c.confirmado === true).length;
                atualizarDisplayNivel(captsConfirmadas);

                const contatosAguardando = meusContatos.filter(c => c.status === 'Aguardando').length;
                avisoContainer.innerHTML = '';
                if (contatosAguardando > 0) {
                    const plural = contatosAguardando > 1 ? 's' : '';
                    avisoContainer.innerHTML = `
                        <div class="bg-yellow-900/50 border border-yellow-700 text-yellow-300 px-4 py-3 rounded-lg relative mb-4 fade-in" role="alert">
                            <strong class="font-bold">Atenção!</strong>
                            <span class="block sm:inline">Você está aguardando resposta de ${contatosAguardando} contato${plural}. Lembre-se de fazer o acompanhamento!</span>
                        </div>
                    `;
                }

                contatosList.innerHTML = '';
                if (querySnapshot.empty) {
                    contatosList.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum contato registrado.</p>';
                    return;
                }

                meusContatos.forEach(contato => {
                    const card = document.createElement('div');
                    let statusClass, statusTextClass;
                    let confirmedIndicator = '';
                    let detalhes = '';
                    let gestorMensagemHtml = '';

                    if (contato.mensagemGestor) {
                        gestorMensagemHtml = `
                            <div class="mt-2 p-2 rounded-md bg-gray-600/50 text-xs italic text-gray-300 border border-gray-500">
                                <strong>Mensagem da Gestão:</strong> ${contato.mensagemGestor}
                            </div>
                        `;
                    }

                    if (contato.status === 'Sucesso' && contato.confirmado === true) {
                        statusClass = 'border-teal-400';
                        statusTextClass = 'text-teal-300';
                        confirmedIndicator = '<span class="text-xs font-bold text-teal-300 ml-2">(Confirmado ✓)</span>';
                        const valorFormatado = (contato.valorPago || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                        detalhes = `<div class="mt-2 text-sm text-gray-300 space-y-1">
                                    <p><strong>Pagador:</strong> ${contato.nomePagador || 'N/A'}</p>
                                    <p><strong>Pagamento:</strong> ${valorFormatado} via ${contato.formaPagamento || 'N/A'}</p>
                                    <p><strong>Avaliação:</strong> ${contato.dataAvaliacao ? new Date(contato.dataAvaliacao + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
                                    <p><strong>Clube:</strong> ${contato.clubeDestino || 'N/A'}</p>
                                </div>`;
                    } else if (contato.status === 'Sucesso') {
                        statusClass = 'border-green-500';
                        statusTextClass = 'text-green-400';
                        const valorFormatado = (contato.valorPago || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                        detalhes = `<div class="mt-2 text-sm text-gray-300 space-y-1">
                                    <p><strong>Pagador:</strong> ${contato.nomePagador || 'N/A'}</p>
                                    <p><strong>Pagamento:</strong> ${valorFormatado} via ${contato.formaPagamento || 'N/A'}</p>
                                    <p><strong>Avaliação:</strong> ${contato.dataAvaliacao ? new Date(contato.dataAvaliacao + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
                                    <p><strong>Clube:</strong> ${contato.clubeDestino || 'N/A'}</p>
                                </div>`;
                    } else if (contato.status === 'Falha') {
                        statusClass = 'border-red-500';
                        statusTextClass = 'text-red-400';
                        detalhes = `<p class="text-sm text-gray-400 mt-2"><strong>Motivo:</strong> ${contato.motivo || 'N/A'}</p>`;
                    } else if (contato.status === 'Reunião Agendada') {
                        statusClass = 'border-cyan-500';
                        statusTextClass = 'text-cyan-400';
                        const dataReuniaoFmt = contato.dataReuniao ? new Date(contato.dataReuniao + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
                        detalhes = `<p class="text-sm text-gray-400 mt-2"><strong>Reunião:</strong> ${dataReuniaoFmt} às ${contato.horaReuniao || 'N/A'}</p>`;
                    } else if (contato.status === 'Standby') {
                        statusClass = 'border-indigo-500';
                        statusTextClass = 'text-indigo-400';
                        const dataLembreteFmt = contato.dataLembrete ? new Date(contato.dataLembrete + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
                        detalhes = `<p class="text-sm text-gray-400 mt-2"><strong>Próximo passo:</strong> ${contato.motivoStandby || 'N/A'}</p><p class="text-xs text-gray-500">Lembrete: ${dataLembreteFmt}</p>`;
                    } else { // Aguardando
                        statusClass = 'border-yellow-500';
                        statusTextClass = 'text-yellow-400';
                        detalhes = `<p class="text-sm text-gray-400 mt-2"><strong>Acompanhamento:</strong> ${contato.previsaoResposta || 'Nenhuma anotação.'}</p>`;
                    }
                    
                    const dataContatoFormatada = contato.data ? new Date(contato.data + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';

                    card.innerHTML = `<div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg">${contato.nome} (Nasc. ${contato.anoNascimento})</p>
                            <p class="text-xs text-gray-400">
                                ${contato.posicao} | ${contato.estado} | Tel: ${formatarTelefone(contato.telefone)}
                            </p>
                            ${contato.nomeResponsavel ? `<p class="text-xs text-gray-400 mt-1">
                                <strong>Resp.:</strong> ${contato.nomeResponsavel} | Tel: ${formatarTelefone(contato.telefoneResponsavel)}
                            </p>` : ''}
                            <p class="text-sm text-gray-300 mt-2"><strong>Contato em:</strong> ${dataContatoFormatada}</p>
                            ${gestorMensagemHtml}
                            ${detalhes}
                        </div>
                        <div class="flex flex-col items-end space-y-2 flex-shrink-0 ml-4">
                            <span class="text-sm font-semibold ${statusTextClass}">${contato.status}${confirmedIndicator}</span>
                            <button data-id="${contato.id}" class="edit-btn text-xs bg-blue-600 hover:bg-blue-500 text-white py-1 px-3 rounded w-full">Editar</button>
                            <button data-id="${contato.id}" class="excluir-btn text-xs bg-gray-600 hover:bg-red-700 text-white py-1 px-3 rounded w-full">Excluir</button>
                        </div>
                    </div>`;

                    contatosList.appendChild(card);
                });
            } catch (error) {
                console.error("Erro ao carregar contatos: ", error);
                contatosList.innerHTML = `<div class="text-center text-red-400 p-4 bg-red-900/50 rounded-lg"><p><strong>Erro ao buscar dados.</strong></p></div>`;
            }
        }
        
        contatosList.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const docId = button.getAttribute('data-id');
            if (!docId) return;

            if (button.classList.contains('excluir-btn')) {
                if (confirm('Tem certeza?')) {
                    await deleteDoc(doc(db, "captacoes", docId));
                    carregarContatos();
                }
            } else if (button.classList.contains('edit-btn')) {
                const contatoParaEditar = meusContatos.find(c => c.id === docId);
                if (contatoParaEditar) abrirModalDeEdicao(contatoParaEditar);
            }
        });

        function abrirModalDeEdicao(contato) {
            contatoOriginal = { ...contato };
            editForm.elements['edit-doc-id'].value = contato.id;
            editForm.elements['edit-atleta-nome'].value = contato.nome;
            editForm.elements['edit-atleta-ano-nascimento'].value = contato.anoNascimento;
            editForm.elements['edit-atleta-estado'].value = contato.estado;
            editForm.elements['edit-atleta-telefone'].value = formatarTelefone(contato.telefone);
            editForm.elements['edit-responsavel-nome'].value = contato.nomeResponsavel || '';
            editForm.elements['edit-responsavel-telefone'].value = formatarTelefone(contato.telefoneResponsavel);
            editForm.elements['edit-status'].value = contato.status;

            if (contato.mensagemGestor) {
                viewGestorMensagem.textContent = contato.mensagemGestor;
                gestorMensagemContainer.classList.remove('hidden');
            } else {
                gestorMensagemContainer.classList.add('hidden');
            }
            
            editForm.elements['edit-previsao-resposta'].value = contato.previsaoResposta || '';
            editForm.elements['edit-data-avaliacao'].value = contato.dataAvaliacao || '';
            editForm.elements['edit-nome-pagador'].value = contato.nomePagador || '';
            editForm.elements['edit-forma-pagamento'].value = contato.formaPagamento || 'Pix';
            editForm.elements['edit-valor-pago'].value = contato.valorPago || '';
            editForm.elements['edit-motivo-falha'].value = contato.motivo || '';
            editForm.elements['edit-data-reuniao'].value = contato.dataReuniao || '';
            editForm.elements['edit-hora-reuniao'].value = contato.horaReuniao || '';
            editForm.elements['edit-motivo-standby'].value = contato.motivoStandby || '';
            editForm.elements['edit-data-lembrete'].value = contato.dataLembrete || '';
            editForm.elements['edit-clube-destino'].value = contato.clubeDestino || '';
            
            toggleEditCampos();
            editModal.style.display = 'flex';
        }

        document.getElementById('cancel-edit-btn').addEventListener('click', () => editModal.style.display = 'none');

        document.getElementById('edit-status').addEventListener('change', toggleEditCampos);

        function toggleEditCampos() {
            const status = document.getElementById('edit-status').value;
            document.getElementById('edit-campos-aguardando').classList.toggle('hidden', status !== 'Aguardando');
            document.getElementById('edit-campos-sucesso').classList.toggle('hidden', status !== 'Sucesso');
            document.getElementById('edit-campos-falha').classList.toggle('hidden', status !== 'Falha');
            document.getElementById('edit-campos-reuniao').classList.toggle('hidden', status !== 'Reunião Agendada');
            document.getElementById('edit-campos-standby').classList.toggle('hidden', status !== 'Standby');
        }

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editForm.elements['edit-doc-id'].value;
            const statusNovo = editForm.elements['edit-status'].value;
            
            const dadosAtualizados = {
                nome: editForm.elements['edit-atleta-nome'].value,
                anoNascimento: parseInt(editForm.elements['edit-atleta-ano-nascimento'].value),
                estado: editForm.elements['edit-atleta-estado'].value,
                telefone: editForm.elements['edit-atleta-telefone'].value.replace(/\D/g, ''),
                nomeResponsavel: editResponsavelNomeInput.value,
                telefoneResponsavel: editResponsavelTelefoneInput.value.replace(/\D/g, ''),
                status: statusNovo,
                
                previsaoResposta: statusNovo === 'Aguardando' ? editForm.elements['edit-previsao-resposta'].value : null,
                dataAvaliacao: statusNovo === 'Sucesso' ? editForm.elements['edit-data-avaliacao'].value : null,
                nomePagador: statusNovo === 'Sucesso' ? editForm.elements['edit-nome-pagador'].value : null,
                formaPagamento: statusNovo === 'Sucesso' ? editForm.elements['edit-forma-pagamento'].value : null,
                valorPago: statusNovo === 'Sucesso' ? parseFloat(editForm.elements['edit-valor-pago'].value) || 0 : null,
                clubeDestino: statusNovo === 'Sucesso' ? editForm.elements['edit-clube-destino'].value : null,
                motivo: statusNovo === 'Falha' ? editForm.elements['edit-motivo-falha'].value : null,
                dataReuniao: statusNovo === 'Reunião Agendada' ? editForm.elements['edit-data-reuniao'].value : null,
                horaReuniao: statusNovo === 'Reuniao Agendada' ? editForm.elements['edit-hora-reuniao'].value : null,
                motivoStandby: statusNovo === 'Standby' ? editForm.elements['edit-motivo-standby'].value : null,
                dataLembrete: statusNovo === 'Standby' ? editForm.elements['edit-data-lembrete'].value : null,
            };

            if (statusNovo !== contatoOriginal.status) {
                const historico = contatoOriginal.historicoStatus || [];
                historico.push({
                    status: statusNovo,
                    dataHora: new Date(),
                    alteradoPor: currentUser.displayName
                });
                dadosAtualizados.historicoStatus = historico;
            }

            await updateDoc(doc(db, "captacoes", id), dadosAtualizados);
            editModal.style.display = 'none';
            carregarContatos();
        });

        document.querySelectorAll('input[name="status"]').forEach(radio => radio.addEventListener('change', toggleStatusFields));

        function toggleStatusFields() {
            const status = document.querySelector('input[name="status"]:checked').value;
            camposAguardando.classList.toggle('hidden', status !== 'Aguardando');
            camposSucesso.classList.toggle('hidden', status !== 'Sucesso');
            camposFalha.classList.toggle('hidden', status !== 'Falha');
            camposReuniao.classList.toggle('hidden', status !== 'Reunião Agendada');
            camposStandby.classList.toggle('hidden', status !== 'Standby');
        }

        document.getElementById('data-contato').valueAsDate = new Date();
        toggleStatusFields();
    </script>
</body>
</html>
